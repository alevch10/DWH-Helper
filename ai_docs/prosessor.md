# Описание
Основной модуль приложение, отвечает за интеграцию разных компонентов приложения между собой, обработку и форматирование данных

# Выполняемые операции
## Экспорт данных из Amplitude в хранилище S3 
### Входные параметры: 
1) Дата с которой выполнять импорт
2) Дата до которой выполнять импорт
3) Дирректория внутри бакета в которую вставлять данные 
### Процесс:
1) Модуль принимает API запрос с указанием даты от и до
2) Модуль иттеративно по неделям выполняет загрузку данных и объединяет в единый файл
-  Внутри недели запросы в API Amplitude разбиваются по суткам (функция amplitude.client.export)
3) Полученные файлы отправляются в указанную дирректорию s3 хранилища

## User Properties Transformer
### Общее описание сервиса

Модуль отвечает за трансформацию и сохранение пользовательских свойств из двух основных источников:
- событий Amplitude, хранящихся в виде JSON-файлов в S3
- промежуточной таблицы `tmp_user_properties` в PostgreSQL

**Цели:**
- Постоянные (статические) свойства → таблица `permanent_user_properties` (одна запись на `ehr_id`)
- Изменяемые свойства → таблица `changeble_user_properties` (только самая свежая версия на каждый `ehr_id`, включая записи с `ehr_id IS NULL`)

**Ключевые принципы (актуальные на 2026 год):**
- Жёсткая валидация: **любой неизвестный ключ** в `user_properties` → фатальная ошибка, процесс прерывается
- **Любая ошибка записи в БД** (insert/upsert/update) → немедленное прерывание обработки
- Конфигурация маппинга полей полностью вынесена в `field_mappings.yaml`
- Инкрементальность: `start_after` для S3, флаг `migrated` для tmp-таблицы
- Ответ API при прерывании содержит точную информацию для возобновления (особенно для S3)

### Текущее состояние реализации (чек-лист)

| №  | Требование / функциональность                                      | Статус     | Примечание / изменения от исходного ТЗ                                                                 |
|----|--------------------------------------------------------------------|------------|----------------------------------------------------------------------------------------------------------|
| 1  | Загрузка маппинга из `field_mappings.yaml` один раз при старте     | ✅ Готово  | `app/processor/__init__.py` → глобальная переменная `MAPPINGS`                                           |
| 2  | Трансформация одной записи (`transform_single_record`)             | ✅ Готово  | Поддерживает оба источника, валидация неизвестных ключей, обработка типов, regex, value_map             |
| 3  | Обработка неизвестных ключей → фатальная ошибка                    | ✅ Готово  | Процесс прерывается, в ответе возвращается информация об ошибке                                         |
| 4  | Сравнение изменяемых свойств (только при отличиях → upsert)        | ✅ Готово  | `compare_changeable` использует `model_fields`, исключает `uuid` и `event_time`                          |
| 5  | Работа с БД через `DWHRepository` (пула соединений, батч-вставка)  | ✅ Готово  | Все операции (`get_all_permanent_ehr_ids`, `upsert_changeable` и др.) идут через репозиторий            |
| 6  | Прерывание при **любой** ошибке записи в БД                        | ✅ Готово  | Добавлен класс `ProcessingInterrupted`, процесс останавливается полностью                               |
| 7  | Для S3: возобновление с конкретной строки файла                    | ✅ Готово  | В ответе: `last_successful_line`, `failed_line`, `file_key`                                              |
| 8  | Для tmp_table: выборка по `migrated = false` через `repo.select()` | ✅ Готово  | Используется универсальный метод `select` с фильтром `{"migrated": False}`                               |
| 9  | Отметка `migrated = true` после успешной обработки                 | ✅ Готово  | `repo.update_migrated_tmp(uuid, True)`                                                                   |
| 10 | Эндпоинт `POST /transform/user-properties`                         | ✅ Готово  | Обрабатывает оба источника, возвращает детали при прерывании (status=interrupted)                        |
| 11 | Логирование ошибок трансформации и записи                          | ✅ Готово  | `log_bads`, `logger.error` / `logger.exception`                                                          |
| 12 | Поддержка `start_after` для S3 (индекс строки)                     | ✅ Готово  | Работает как 0-based индекс в файле                                                                      |
| 13 | Unit-тесты на `transform_single_record`                            | □ Не готово| Рекомендуется добавить (разные кейсы: unknown key, неверный тип, возраст с regex и т.д.)                 |
| 14 | Интеграционные тесты с моками S3 и БД                              | □ Не готово| Желательно (pytest + responses + pytest-postgresql или mocks)                                           |
| 15 | Обработка директории в S3 (несколько файлов по префиксу)           | □ Не готово| Пока поддерживается только один файл; можно доработать цикл по списку объектов                           |
| 16 | Retry при временных ошибках БД / S3                                | □ Не готово| Пока нет; можно добавить exponential backoff в будущем                                                   |

### Текущее поведение при ошибках (самое важное отличие от исходного ТЗ)

| Тип ошибки                              | Поведение в S3                              | Поведение в tmp_table                     | Что возвращает API                                      |
|-----------------------------------------|---------------------------------------------|--------------------------------------------|----------------------------------------------------------|
| Неизвестный ключ в user_properties      | Прерывание, ответ с позицией                | Прерывание (было: пропуск)                 | status=interrupted + last_successful_line, failed_line   |
| Ошибка парсинга числа / bool            | Прерывание (было: None + лог)               | Прерывание (было: None + лог)              | status=interrupted + error_message                       |
| Ошибка записи в БД (insert/upsert/update) | Прерывание немедленно                     | Прерывание немедленно                      | status=interrupted + error_message                       |
| Ошибка чтения файла S3 / JSON           | Прерывание на этапе чтения                  | —                                          | status=interrupted + file_key (без строки)               |

### Рекомендации для следующих разработчиков / ИИ-агентов

1. Добавить поддержку обработки **директории в S3** (перечисление объектов по префиксу, сортировка по имени, последовательная обработка)
2. Реализовать **retry-механизм** для временных ошибок (S3 5xx, БД connection lost, deadlock) — 3–5 попыток с backoff
3. Добавить **пагинацию** для tmp_table при большом количестве unmigrated записей (по 1000–5000 за раз)
4. Написать **unit-тесты** для `transformer.py` (минимум 15–20 кейсов)
5. Добавить **метрики** (prometheus): processed_records_total, errors_total, processing_duration_seconds, interrupted_count
6. Рассмотреть **асинхронный** вариант оркестратора (если нагрузка вырастет)

