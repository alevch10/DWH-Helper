# –û–ø–∏—Å–∞–Ω–∏–µ
–î–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö DWH. –û–Ω –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –ë–î, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ config 
–ú–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å —Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü –ë–î –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∏—Ö. 
–£ –º–æ–¥—É–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ API, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å GET –∏ POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã, –∞ —Ç–∞–∫–∂–µ, –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –±—É–¥—É—Ç –¥–µ–ª–∞—Ç—å select –∏ insert –∑–∞–ø—Ä–æ—Å—ã –≤ —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã. 

## üß© –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π)

```python
from app.dwh_tables_worker.repository import DWHRepository

repo = DWHRepository()

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ ehr_id
ehr_set = repo.get_all_permanent_ehr_ids()

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ ehr_id
latest = repo.get_latest_changeable_for_ehrs([1, 2, None])

# UPSERT –∏–∑–º–µ–Ω—è–µ–º–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
from app.dwh_tables_worker.schemas import ChangeableUserProperties
record = ChangeableUserProperties(...)
repo.upsert_changeable(record)

# –ü–æ–º–µ—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ tmp_user_properties –∫–∞–∫ migrated
from uuid import UUID
repo.update_migrated_tmp(UUID("..."), migrated=True)
```


## –¢–∞–±–ª–∏—Ü—ã –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ: 
–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é —Å—Ö–µ–º–∞–º –≤ dwh_tables_worker.schemas

# ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (–¥–ª—è –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤)
## –û–±—â–∏–µ
- –ú–æ–¥—É–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ config.settings.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (ThreadedConnectionPool).
- –í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—é, –∑–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π.
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º DBClass).

## API (router)
- –î–ª—è –∫–∞–∂–¥–æ–π –∏–∑ 8 —Ç–∞–±–ª–∏—Ü –µ—Å—Ç—å POST –∏ GET —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.
- GET –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É (pk).
- GET –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç limit, sort_by, sort_dir.
- GET –¥–ª—è /user-properties –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ migrated.
- POST –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –±–∞—Ç—á –æ–±—ä–µ–∫—Ç–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∞–Ω–∫—É–µ—Ç.
- POST –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π (inserted_ids).
- POST –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç—á–µ–π (batches).

## –°—Ö–µ–º—ã (schemas)
- –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –æ–ø–∏—Å–∞–Ω—ã Pydantic-–º–æ–¥–µ–ª—è–º–∏.
- –ü–æ–ª—è event_time –∏–º–µ—é—Ç —Ç–∏–ø datetime (—Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ISO 8601).
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞—Ç—ã –≤—ã–∑—ã–≤–∞—é—Ç HTTP 422, –Ω–∏–∫–∞–∫–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–º–µ–Ω—ã.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã @field_validator(mode='before') –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫.

## –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (repository)
- –û–±—â–∏–µ –º–µ—Ç–æ–¥—ã: insert_one, insert_batch, select, get_by_pk.
- insert_batch –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—å–Ω–æ–º—É –ª–∏–º–∏—Ç—É PostgreSQL (65‚ÄØ535 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤).
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç max_rows –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª–µ–π –≤ –º–æ–¥–µ–ª–∏.
- RETURNING –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
- –ü–æ–¥—Å—á—ë—Ç –±–∞—Ç—á–µ–π –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤–º–µ—Å—Ç–µ —Å ID.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ON CONFLICT (DO NOTHING / DO UPDATE).
- –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã: get_all_permanent_ehr_ids, get_latest_changeable_for_ehrs, upsert_changeable, update_migrated_tmp ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏–∑ DBClass.

