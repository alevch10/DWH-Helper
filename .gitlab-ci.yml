# .gitlab-ci.yml

stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$DOCKER_IMAGE" .
    - docker push "$DOCKER_IMAGE"
  only:
    - tags

deploy:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
  before_script:
    - apk add --no-cache openssh
  script:
    - |
      # Генерируем .env из CI/CD переменных и секретов
      echo "TITLE=$TITLE" > .env
      echo "DESCRIPTION=$DESCRIPTION" >> .env
      echo "LOGGING_LEVEL=$LOGGING_LEVEL" >> .env
      echo "DWH_MAX_WRITE_BATCH_BYTES=$DWH_MAX_WRITE_BATCH_BYTES" >> .env
      echo "DWH_MAX_ROWS_PER_INSERT=$DWH_MAX_ROWS_PER_INSERT" >> .env
      echo "APPMETRICA_BASE_URL=$APPMETRICA_BASE_URL" >> .env
      echo "APPMETRICA_APPLICATION_ID=$APPMETRICA_APPLICATION_ID" >> .env
      echo "APPMETRICA_POLL_INTERVAL_SECONDS=$APPMETRICA_POLL_INTERVAL_SECONDS" >> .env
      echo "APPMETRICA_POLL_TIMEOUT_SECONDS=$APPMETRICA_POLL_TIMEOUT_SECONDS" >> .env
      echo "S3_REGION=$S3_REGION" >> .env
      echo "S3_ENDPOINT_URL=$S3_ENDPOINT_URL" >> .env
      echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> .env
      echo "S3_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID" >> .env
      echo "AMPLITUDE_WEB_CLIENT_ID=$AMPLITUDE_WEB_CLIENT_ID" >> .env
      echo "AMPLITUDE_MOBILE_CLIENT_ID=$AMPLITUDE_MOBILE_CLIENT_ID" >> .env
      echo "DWH_DATABASE_URL=$DWH_DATABASE_URL" >> .env
      echo "APPMETRICA_API_KEY=$APPMETRICA_API_KEY" >> .env
      echo "S3_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY" >> .env
      echo "AMPLITUDE_WEB_SECRET_KEY=$AMPLITUDE_WEB_SECRET_KEY" >> .env
      echo "AMPLITUDE_MOBILE_SECRET_KEY=$AMPLITUDE_MOBILE_SECRET_KEY" >> .env
      echo "VERSION=$CI_COMMIT_TAG" >> .env
      scp -o StrictHostKeyChecking=no .env $SSH_USER@$SSH_HOST:/root/.env
      ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
        docker pull $DOCKER_IMAGE
        docker stop dwh-helper || true
        docker rm dwh-helper || true
        docker run -d --name dwh-helper --env-file /root/.env -p 8000:8000 $DOCKER_IMAGE
      EOF
  only:
    - tags
