stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
    - docker build -t "$DOCKER_IMAGE" .
    - docker push "$DOCKER_IMAGE"
  rules:
    - if: '$CI_COMMIT_TAG'

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - |
      cat > .env << EOF
      TITLE=DWH Helper
      VERSION=$CI_COMMIT_TAG
      DESCRIPTION=Product analytics data ingestion and DWH integration
      DEBUG=$DEBUG
      AUTH_READ_ACCESS=$AUTH_READ_ACCESS
      AUTH_WRITE_ACCESS=$AUTH_WRITE_ACCESS
      LOGGING_LEVEL=$LOGGING_LEVEL
      DB_NAME=$DB_NAME
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_HOST=$DB_HOST
      DB_PORT=$DB_PORT
      DB_MAX_PARAMS_PER_QUERY=$DB_MAX_PARAMS_PER_QUERY
      DB_MAX_ROWS_PER_INSERT=$DB_MAX_ROWS_PER_INSERT
      DB_SAFETY_FACTOR=$DB_SAFETY_FACTOR
      DB_MINCON=$DB_MINCON
      DB_MAXCON=$DB_MAXCON
      APPMETRICA_BASE_URL=$APPMETRICA_BASE_URL
      APPMETRICA_APPLICATION_ID=$APPMETRICA_APPLICATION_ID
      APPMETRICA_POLL_INTERVAL_SECONDS=$APPMETRICA_POLL_INTERVAL_SECONDS
      APPMETRICA_POLL_TIMEOUT_SECONDS=$APPMETRICA_POLL_TIMEOUT_SECONDS
      S3_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID
      S3_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY
      S3_REGION=$S3_REGION
      S3_ENDPOINT_URL=$S3_ENDPOINT_URL
      S3_BUCKET_NAME=$S3_BUCKET_NAME
      AMPLITUDE_WEB_SECRET_KEY=$AMPLITUDE_WEB_SECRET_KEY
      AMPLITUDE_WEB_CLIENT_ID=$AMPLITUDE_WEB_CLIENT_ID
      AMPLITUDE_MOBILE_SECRET_KEY=$AMPLITUDE_MOBILE_SECRET_KEY
      AMPLITUDE_MOBILE_CLIENT_ID=$AMPLITUDE_MOBILE_CLIENT_ID
      YANDEX_CLIENT_ID=$YANDEX_CLIENT_ID
      YANDEX_CLIENT_SECRET=$YANDEX_CLIENT_SECRET
      ETL_BATCH_SIZE=$ETL_BATCH_SIZE
      EOF

    - scp -o StrictHostKeyChecking=no .env $SSH_USER@$SSH_HOST:$APP_PATH/.env
    - ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
        cd $APP_PATH &&
        docker compose pull &&
        docker compose up -d --remove-orphans --force-recreate &&
        docker compose ps &&
        docker compose logs --tail=30
      "
  rules:
    - if: '$CI_COMMIT_TAG'